{% extends 'masonry.html' %}

{% block title%} Profile {% endblock %}

{% block content %}
<div class="container">
    <div class="container">
        <h2>User Profile</h2>
        <p>Welcome {{ user.username }}</p>
    </div>

    <div class="container mt-5">
        <h4>Account Details</h4>
        <div class="d-flex justify-content-between">
            <div>
                <a href="/users/profile/change_username/" class="btn btn-primary">Change Username</a>
                <a href="/users/profile/change_password/" class="btn btn-primary">Change Password</a>
                <a href="/users/profile/delete/" class="btn btn-danger">Delete Account</a>
            </div>
            <div>
                {% if request.user.is_admin %}
                    <a href="/admin" class="btn btn-warning">Admin</a>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="container mt-5">
        <h4>Security</h4>
        <div class="d-flex">
            <div class="mt-1">
                {% if user.otp %}
                    <form action="{% url 'users:toggle_otp' %}" method="post">
                        {% csrf_token %}
                            <button type="submit" class="btn {% if user.otp %}btn-warning{% else %}btn-success{% endif %}">
                                Disable OTP
                            </button>
                    </form>
                {% else %}
                    <form action="{% url 'users:setup_otp' %}" method="post">
                        {% csrf_token %}
                            <button type="submit" class="btn {% if user.otp %}btn-warning{% else %}btn-success{% endif %}">
                                Enable OTP
                            </button>
                    </form>
                {% endif %}
            </div>
            <div class="p-1">
                <button id="addPasskeyBtn" class="btn btn-primary">Add a Passkey</button>
            </div>
        </div>
    </div>
</div>

<script>

    const { startRegistration } = SimpleWebAuthnBrowser;

    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
    }

    // <button>
    const elemBegin = document.getElementById('addPasskeyBtn');
    // <span>/<p>/etc...
    //const elemSuccess = document.getElementById('success');
    // <span>/<p>/etc...
    //const elemError = document.getElementById('error');

    // Start registration when the user clicks a button
    elemBegin.addEventListener('click', async () => {
      // Reset success/error messages
      //elemSuccess.innerHTML = '';
      //elemError.innerHTML = '';

      // GET registration options from the endpoint that calls
      // @simplewebauthn/server -> generateRegistrationOptions()
      const resp = await fetch('/web_auth/registration/');

      let attResp;
      try {
        // Pass the options to the authenticator and wait for a response
        attResp = await startRegistration(await resp.json());
      } catch (error) {
        // Some basic error handling
        //if (error.name === 'InvalidStateError') {
        //  elemError.innerText = 'Error: Authenticator was probably already registered by user';
        //} else {
        //  elemError.innerText = error;
        //}

        throw error;
      }

      // POST the response to the endpoint that calls
      // @simplewebauthn/server -> verifyRegistrationResponse()
      const verificationResp = await fetch('/web_auth/registration_verification/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken'),
        },
        body: JSON.stringify(attResp),
      });

      // Wait for the results of verification
      const verificationJSON = await verificationResp.json();

      // Show UI appropriate for the `verified` status
      if (verificationJSON && verificationJSON.verified) {
        console.log('Successo!');
      //  elemSuccess.innerHTML = 'Success!';
      } else {
        console.error('Qualcosa Ã¨ andato storto!', verificationJSON);
      //  elemError.innerHTML = `Oh no, something went wrong! Response: <pre>${JSON.stringify(
      //    verificationJSON,
      //  )}</pre>`;
      }
    });
    
</script>

{% endblock %}